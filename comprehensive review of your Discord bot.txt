 comprehensive review of your Discord bot's message history system. Here's what I found:
Overview of the System
Your bot uses a multi-guild database architecture:
Global config: database/guild_config.db - stores guild settings and fetch progress
Per-guild chat DBs: database/{guild_id}/chat_history.db - stores actual messages
Data Flow
Message Capture â†’ Storage â†’ API â†’ Frontend Display
Capture: drongo.py:356-469 - on_message() handler
Storage: database.py - Stores in messages and embed_fields tables
API: web/dashboard_server.py:2384-2820 - REST endpoints
Frontend: web/frontend/src/components/chat/ChatHistoryView.tsx
Critical Issues Found
ğŸ”´ Issue 1: Content Overloading
database.py:373-397 stores ALL content types (text, attachments, embeds) in a single message_content TEXT field. Problems:
Can't query by message type
Attachment URLs mixed with text
Embed data duplicated (stored in both string form AND embed_fields table)
Hard to reconstruct original message structure
Recommendation: Split into text_content, attachments (JSON), embeds (JSON)
ğŸ”´ Issue 2: Orphaned Embed Data
The embed_fields table exists database_schema.py:60-66 but is never queried by the API endpoints. Problems:
Wasted storage
Data inconsistency risk
Code duplication
Recommendation: Either JOIN and return embed data in API, or remove the table
ğŸ”´ Issue 3: No Message Deletion Handling
No on_message_delete event handler exists. Problems:
Deleted Discord messages persist forever
Database grows unbounded
Shows outdated/deleted content
Recommendation: Add deletion event handler to mark/remove deleted messages
ğŸŸ¡ Issue 4: Performance - User Name Resolution
dashboard_server.py:66-162 resolves user names via Discord API for every message in response. Problems:
O(n) API calls per request
Slow response times for large channels
5-minute cache may show stale names
Recommendation: Pre-cache all guild member names on startup
ğŸŸ¡ Issue 5: Weak Deduplication
database.py:151 only checks for duplicates within a 10-second window. Problems:
If bot restarts and refetches messages, duplicates created
Historical duplicates persist
Recommendation: Add unique constraint on (guild_id, channel_id, user_id, timestamp, content_hash)
ğŸŸ¡ Issue 6: No Transaction Safety
database.py:164-171 inserts message, then embed_fields separately without a transaction. Problems:
If embed insert fails, orphaned message record
Data integrity risk
Recommendation: Wrap in BEGIN TRANSACTION / COMMIT
ğŸŸ¡ Issue 7: Frontend Field Name Mismatch
Backend sends message_content, but useChatHistory.ts:79-88 maps to content. Current mapping:

{
  id: msg.id,
  author_id: msg.user_id,
  author_name: msg.username,
  content: msg.message_content,  // â† Backend sends "message_content"
  timestamp: msg.timestamp,
  // ...
}
This should work, but verify the mapping is correct.
ğŸŸ¡ Issue 8: No Rate Limiting
API endpoints dashboard_server.py:2536+ have no rate limiting. Problems:
Vulnerable to DOS attacks
Database exhaustion
Recommendation: Add rate limiting middleware
ğŸŸ  Issue 9: No Data Retention Policy
Messages stored indefinitely with no cleanup. Problems:
Disk space grows unbounded
GDPR compliance risk (right to be forgotten)
Recommendation: Add configurable retention period
ğŸŸ  Issue 10: Performance at Scale
dashboard_server.py:2703 does full table scan for COUNT(DISTINCT channel_id). Problems:
Slow on guilds with millions of messages
Dashboard stats endpoint lag
Recommendation: Cache aggregate counts, update incrementally
What's Working Well
âœ… Multi-guild architecture with connection pooling
âœ… WAL mode enabled for better concurrency
âœ… Message batching (100-message batches)
âœ… Real-time dashboard updates (5-10 second refresh)
âœ… Historical message backfill system
âœ… Pagination support on main messages endpoint
Recommendations Priority
High Priority:
Add on_message_delete handler
Fix transaction safety for message + embed inserts
Add rate limiting to API endpoints
Improve deduplication (unique constraint)
Medium Priority: 5. Separate content into dedicated columns 6. Cache user/guild names server-side 7. Either use or remove embed_fields table 8. Add data retention policy Low Priority: 9. Optimize aggregate queries with caching 10. Add more indexes for common query patterns Would you like me to fix any of these issues? I can start with the high-priority items like adding message deletion handling and transaction safety.